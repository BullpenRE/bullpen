<%= render partial: 'freelancer/navigation', locals: { section: 'contracts' } %>
<%= render partial: 'shared/notice_and_alert' %>

<% if @contracts.offers.any? %>
  <!--Offer card-->
  <div class="container mb-3">
    <h1>Offers <i class="far fa-question-circle text-primary"></i></h1>
    <% @contracts.offers.each do |contract| %>
      <%= render partial: 'shared/contracts/show_offer_contract_details', locals: { contract: contract } %>
      <%= render partial: 'freelancer/interviews/send_message', locals: { id: contract.id, employer_profile: contract.employer_profile, redirect_reference: 'contracts' } %>
      <%= render partial: 'freelancer/contracts/decline_offer', locals: { contract: contract } %>
      <div class="bp-card mb-3 card<%= contract.id %>">
        <div class="d-flex flex-column flex-lg-row">
          <div class="mr-auto mb-0"><h2 class="text-wrap text-break"><%= contract&.title&.capitalize %></h2></div>
          <div class="d-flex flex-column flex-md-row my-2 my-lg-0">
            <div class="d-block p-1 d-sm-inline-block">
              <div class="bp-text-sm text-secondary text-nowrap font-weight-bold align-self-center align-self-start ml-1 mr-2 mt-1">
                <%= "Offer #{contract.state}" %>
              </div>
            </div>
            <div class="d-block p-md-1 mb-1 mb-md-0 d-sm-inline-block">
              <button class="btn btn-primary container-fluid accept_offer-<%= contract.id %>" type="button">Accept Offer</button>
            </div>
            <div class="dropdown">
              <button class="btn btn-outline-primary dropdown-toggle pr-1 mt-1 container-fluid" type="button" id="dropdownMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
               More <i class="fas fa-chevron-down text-primary"></i>
              </button>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                <button class="dropdown-item" type="button" data-toggle="modal" data-target="#showOfferContractDetails<%= contract.id %>">
                  Show Offer Details
                </button>
                <button class="dropdown-item text-danger" type="button" data-toggle="modal" data-target="#declineOffer<%= contract.id %>">
                  Decline Offer
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="bp-text-sm mb-2">Created <%= time_ago_in_words(contract&.created_at) %> ago </div>
        <div class="row">
          <div class="col-lg-8">
            <%= render partial: 'shared/contract_short_description', locals: { contract: contract } %>
          </div>
        </div>
        <hr style="margin-top:0;">
        <div class="d-flex justify-content-between flex-column flex-lg-row">
          <%= render partial: 'shared/about_employer_short', locals: { employer_profile: contract.employer_profile } %>
          <div class="d-block p-md-1 mb-1 mb-md-0 d-sm-inline-block">
            <button class="btn btn-outline-primary container-fluid" type="button"  data-toggle="modal" data-target="#sendMessage<%= contract.id %>">Send Message</button>
          </div>
        </div>
      </div>
      <script>
        $('.accept_offer-'+<%= contract.id %>).click(() => {
          $.ajax({
            url: '/freelancer/accept_offer',
            data: { id: '<%= contract.id %>' },
            method: 'POST',
            success: () => {
              document.location.reload();
            }
          })
        })
      </script>
    <% end %>
  </div>
<% end %>

<% if @contracts.any? %>
  <!--Contract card-->
  <div class="container mb-3">
    <h1>Contracts <i class="far fa-question-circle text-primary"></i></h1>
    <% @contracts.active.each do |contract| %>
      <%= render partial: 'shared/contracts/show_offer_contract_details', locals: { contract: contract } %>
      <%= render partial: 'freelancer/interviews/send_message', locals: { id: contract.id, employer_profile: contract.employer_profile, redirect_reference: 'contracts' } %>
      <%= render partial: 'freelancer/contracts/close_contract', locals: { contract: contract } %>
      <%= render partial: 'freelancer/contracts/delete_contract', locals: { contract: contract } %>
      <div class="bp-card mb-3 card<%= contract.id %>">
        <div class="d-flex flex-column flex-lg-row">
          <div class="mr-auto"><h2 class="text-wrap text-break"><%= contract&.title&.capitalize %></h2></div>
          <div class="d-flex flex-column flex-md-row my-2 my-lg-0">
            <div class="d-block p-1 d-sm-inline-block">
              <div class="bp-text-sm text-secondary text-nowrap font-weight-bold align-self-center align-self-start ml-1 mr-2 mt-1">
                <%= contract.closed? ? 'Closed' : 'Active' %>
              </div>
            </div>
            <% unless contract.closed? %>
              <div class="d-block p-md-1 mb-1 mb-md-0 d-sm-inline-block">
                <button class="btn btn-primary container-fluid" type="button">Add Hours</button>
              </div>
            <% end %>
            <div class="dropdown">
              <button class="btn btn-outline-primary dropdown-toggle pr-1 mt-1 container-fluid" type="button" id="dropdownMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                More <i class="fas fa-chevron-down text-primary"></i>
              </button>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                <button class="dropdown-item" type="button" data-toggle="modal" data-target="#showOfferContractDetails<%= contract.id %>">
                  Show Contract Details
                </button>
                <% if contract.closed? %>
                  <button class="dropdown-item text-danger" type="button" data-toggle="modal" data-target="#deleteContract<%= contract.id %>">
                    Delete Contract
                  </button>
                <% else %>
                  <button class="dropdown-item text-danger" type="button" data-toggle="modal" data-target="#closeContract<%= contract.id %>">
                    Close Contract
                  </button>
                <% end %>
              </div>
            </div>
          </div>
        </div>
        <div class="bp-text-sm mb-2">Created <%= time_ago_in_words(contract&.created_at) %> ago </div>
        <div class="row">
          <div class="col-lg-8">
            <%= render partial: 'shared/contract_short_description', locals: { contract: contract } %>
          </div>
        </div>
        <hr style="margin-top:0;">
        <div class="d-flex justify-content-between flex-column flex-lg-row">
          <%= render partial: 'shared/about_employer_short', locals: { employer_profile: contract.employer_profile } %>
          <div class="d-block p-md-1 mb-1 mb-md-0 d-sm-inline-block">
            <button class="btn btn-outline-primary container-fluid" type="button"  data-toggle="modal" data-target="#sendMessage<%= contract.id %>">Send Message</button>
          </div>
        </div>

        <div class="column d-flex justify-content-end align-items-end">
          <a class="font-weight-bold mb-2 link_action<%= contract.id %> more-less<%= contract.id %>" data-toggle="collapse" data-target="#collapseBillings<%= contract.id %>" aria-expanded="true" aria-controls="collapseBillings<%= contract.id %>">
            Show Billing<i class="fas fa-chevron-down ml-1"></i>
          </a>
          <a style="display: none" class="font-weight-bold mb-2 link_action<%= contract.id %> more-less<%= contract.id %>" data-toggle="collapse" data-target="#collapseBillings<%= contract.id %>" aria-expanded="true" aria-controls="collapseBillings<%= contract.id %>">
            Show Less<i class="fas fa-chevron-up ml-1"></i>
          </a>
        </div>
        <div id="collapseBillings<%= contract.id %>" class="collapse">
          billings...
        </div>

        <script>
          $('.link_action<%= contract.id %>').on('click', () => {
            $('.more-less<%= contract.id %>').toggle();
          })
        </script>

      </div>
    <% end %>
  </div>
<% end %>
