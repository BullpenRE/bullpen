<script>
  $(document).on('turbolinks:load', function (e) {
    function showAlert(locationValue) {
      return Swal.fire({
        title: '<h5>Location Not Found</h5>',
        text: `The entered location of '${locationValue}' was not successfully identified. Please check the spelling and enter in a 'City, State' format. The state can be a 2 letter abbreviation.`,
        confirmButtonText: 'Try Again'
      });
    }

    function setHiddenFields(longitude, latitude, controller_name) {
      return `
      <input value=${longitude} type="hidden" name="${controller_name}[longitude]" id="${controller_name}_longitude">
      <input value=${latitude} type="hidden" name="${controller_name}[latitude]" id="${controller_name}_latitude">
      `
    }

    $('.container').off('click').on('click', '#submitWithLocationCheck', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const locationValue = $('#freelancerLocationInput').val();
      if (!locationValue) return showAlert(locationValue);
      const $form = $(e.target).parents('form');
      $.ajax({
        url: `https://nominatim.openstreetmap.org/search?q=${locationValue}&format=json&addressdetails=1&accept-language=en`,
        method: 'GET',
        success: function (data) {
          if (data.length < 1 || data === undefined) {
            showAlert(locationValue)
          } else {
            const longitude = data[0]['lon'];
            const latitude = data[0]['lat'];
            $form.prepend(setHiddenFields(longitude, latitude, '<%= controller_name %>'));
            if (!$('.highlight').length) $form.submit()
          }
        },
        error: () => {
          showAlert(locationValue)
        }
      });
    })
  })
</script>